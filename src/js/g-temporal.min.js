G.Layer.TiledTemporal=G.Layer.TiledService.extend({mixins:[],options:{radiusUnit:"pixel",dataCubeTileSize:256,dataCubeResolution:4,colorBuckets:[{value:1,color:"#5CA2D1"},{value:0,color:"#F84F40"}],markerSizeBuckets:[{value:3,markerSize:9},{value:2,markerSize:7},{value:1,markerSize:5},{value:0,markerSize:3}],rendererType:"circle",maxOpacity:1,minOpacity:0,frameCount:10,frameDuration:200,isExpand:!0,frameAnimStepCount:3},init:function(e,t,a){var i=this;i.url=e,i._timeFunc=t,i.options=G.Util.merge({},i.options,a),i._tiles={},i._isKeyStep=!1,i._playing=!1,i._time=null,i._step=-1,i._colorBuckets=i.options.colorBuckets,0===i._colorBuckets&&(i._colorBuckets[0]={value:0,color:"#F84F40"}),i._markerSizeBuckets=i.options.markerSizeBuckets,0===i._markerSizeBuckets.length&&(i._markerSizeBuckets[0]={value:0,markerSize:3}),i._tileOffset=i._markerSizeBuckets[0].markerSize,"map"===a.radiusUnit&&(i._tileOffset/=map._res);var r=function(e,t,a){var r=i._getTileName(e,t,a),n=i._getTileUrl(e,t,a),o=[e,t,a];G.Util.ajax(n,{responseType:"JSONP",success:function(e,t){i.onSuccess(o,t);var a={};a.renderData=t.data,a.tileInfo=o,a.tileCache=[],a.animCache=[],i._tiles[r]=a},error:function(e){i.onError(o)},complete:function(e){i.onComplete(o)}})};G.Layer.TiledService.prototype.init.call(i,r,i.options)},start:function(){var e=this;return!e._playing&&e.options.frameCount>-1&&(e._startAnim(),e._playing=!0),e},stop:function(){var e=this;return G.Util.cancelAnimFrame(e._requestId),e._playing=!1,e._step=-1,e},pasue:function(){var e=this;return e._playing&&(G.Util.cancelAnimFrame(e._requestId),e._playing=!1,e._isKeyStep=!0),e},setStep:function(e){var t=this,a=t._map;t.options;t._playing||e>-1&&e<options.frameCount&&(t._step=e,a._requestRedraw())},_startAnim:function(){var e=this,t=e._map,a=e.options;!function i(r){try{if(!r)return void(e._requestId=G.Util.requestAnimFrame(i));null===e._time&&(e._time=r),e._diff=(r-e._time)/a.frameDuration,e._diff>1?(e._isKeyStep=!0,e._step++,e._step>a.frameCount+a.frameAnimStepCount-1&&(e._step=0),t._requestRedraw(),e._timeFunc(e._step),e._time=r):(e._isKeyStep=!1,e._diff>=.5&&e._step<a.frameCount&&e._draw()),e._requestId=G.Util.requestAnimFrame(i)}catch(n){console.log(n)}}()},_draw:function(){var e=this,t=e._tiles,a=e._ctx,i=e._step,r=e._map,n=e.options;n.radius;if(!(r.isZooming()||r.isPinching()||r.isRotating()||r.isPanning())){if(e._isKeyStep){var o=a.canvas,s=o.width,l=o.height;a.clearRect(0,0,s,l);for(var c in t){var _=t[c],u=_.tileInfo;_.tileCache[i]||e._renderTile(_,i);var f=_.tileCache[i];f!==-1&&e._placeTile(f.canvas,u[0],u[1],u[2]);for(var m=n.frameAnimStepCount,p=1;p<=m;p++){var v=i-p,d=null,h=.8*(m+1-p)/(m+1),g=h*(n.maxOpacity-n.minOpacity)+n.minOpacity;v>=0&&g>=0&&(n.isExpand?(_.animCache[v]||e._renderTile(_,v,!0),d=_.animCache[v]):(_.tileCache[v]||e._renderTile(_,v),d=_.tileCache[v]),d!==-1&&(a.save(),a.globalAlpha=g,e._placeTile(d.canvas,u[0],u[1],u[2]),a.restore()))}}}else if(e._playing&&!e._isKeyStep){i+=1;for(var c in t){var _=t[c];_.tileCache[i]||e._renderTile(_,i),n.isExpand&&(_.animCache[i]||e._renderTile(_,i,!0))}return}if(!e._hidden){var S=r._useOffScreen?r._offScreenCtx:r._onScreenCtx,C=S.canvas;S.drawImage(a.canvas,0,0,C.width,C.height)}}},_renderTile:function(e,t,a){for(var i=this,r=(i.map,i.options),n=e.renderData,o=r.dataCubeResolution,s=[],l=0;l<n.length;l++){var c=n[l];values=c.vals__uint8,dates=c.dates__uint16;for(var _=0;_<dates.length;_++)if(dates[_]===t){s.push({x:c.x__uint8,y:c.y__uint8,value:values[_]});break}}if(0===s.length)return e.tileCache[t]=-1,void(a&&(e.animCache[t]=-1));for(var u=[],f=0;f<i._colorBuckets.length;f++)u[f]=[];for(var l=s.length-1;l>=0;l--)for(var m=s[l].value,f=0;f<i._colorBuckets.length;f++){var p=i._colorBuckets[f].value;if(m>=p){u[f].push(s[l]);break}}var v=G.DomUtil.create("canvas").getContext("2d"),d=v.canvas,h=d.width=d.height=r.dataCubeTileSize+2*i._tileOffset;v.clearRect(0,0,h,h),v.globalAlpha=r.maxOpacity;for(var f=0;f<i._colorBuckets.length;f++){var g=i._colorBuckets[f].color;v.fillStyle=g,v.beginPath();for(var S=u[f],C=0;C<S.length;C++){for(var k=S[C].x,y=S[C].y,m=S[C].value,x=o/2+k*o+i._tileOffset,z=-o/2+(r.dataCubeTileSize/o-y)*o+i._tileOffset,T=0,B=0;B<i._markerSizeBuckets.length;B++){var p=i._markerSizeBuckets[B].value,R=i._markerSizeBuckets[B].markerSize;if(m>=p){T=R;break}}0!==T&&(a&&(T+=2),"rectangle"===r.rendererType?v.rect(x-T,z-T,2*T,2*T):v.arc(x,z,T,0,2*Math.PI),v.closePath())}v.fill()}a?e.animCache[t]=v:e.tileCache[t]=v},_placeTile:function(e,t,a,i){var r=Math.round,n=this,o=G.MathUtil,s=G.Browser.getPxRatio(),l=s[0],c=s[1],_=n.options,u=n._map,f=u._rotate,m=u.options,p=u._res,v=_.zoomReses[i],d=_.dataCubeTileSize,h=d*v,g=Math.ceil((d+2*n._tileOffset)*v/p),S=_.originX+t*h,C=_.originY-a*h;if(!(g>4*(d+2)||g<d/8)){var k=0,y=0,x=m.maxExtent,z=x[2]-x[0];if(m.wrap){var T=n._redrawExtent;T&&x&&(y=Math.floor((T[0]-_.minX)/z)-1,k=Math.ceil((T[2]-_.maxX)/z)+1)}for(var B=y;B<=k;B++){var R=S+B*z,O=C,w=u._canvasOffset,U=u.toScreen([R,O]),A=U[0]+w[0]-n._tileOffset,b=U[1]+w[1]-n._tileOffset;A=r(A),b=r(b);var I=n._ctx;f&&(I.save(),I.translate(A,b),I.rotate(f/o.DEGREE_PER_RADIAN),I.translate(-A,-b));try{I.drawImage(e,A,b,r(g/l),r(g/c))}catch(q){}f&&I.restore()}}},_onUpdated:function(){var e=this,t=e._map;e.options;t._requestRedraw()},_onAdded:function(){var e=this,t=e._map;e._initContainer(),t._requestUpdate(),e.addListener("unusedTile",e._onUnusedTile,e)},_onRemoved:function(){var e=this,t=e._map;t.removeListener("resize",e._onReize,e)},_onUnusedTile:function(e){var t=this,a=e.tileInfo,i=t._getTileName(a[0],a[1],a[2]);delete t._tiles[i]},_initContainer:function(){var e=this,t=e._map,a=G.DomUtil;e._ctx||(e._ctx=a.create("canvas").getContext("2d")),t.addListener("resize",e._onResize,e),e._onResize()},_onResize:function(){var e=this,t=e._map,a=t._useOffScreen?t._offScreenCtx:t._onScreenCtx,i=a.canvas,r=e._ctx,n=r.canvas,o=G.Browser.getCanvasRatio(),s=o?o[0]||1:1,l=o?o[1]||1:1;r.scale(s,l),n.width=i.width,n.height=i.height}});