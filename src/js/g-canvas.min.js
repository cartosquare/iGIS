G.Layer.Graphic=G.Layer.Graphic.extend({_update:function(){var e=this;e._draw()},_draw:function(){var e=this,t=e._map,a=e._ctx=t._useOffScreen?t._offScreenCtx:t._onScreenCtx;a.save();var r,i,o=t.getRedrawExtent(),n=e._tree.search(o).sort(e._sortIndex);for(var l in n)r=n[l],i=r.bbox,r._layer&&G.ExtentUtil.overlaps(i,o)&&r._draw();a.restore()}}),G.Layer.Html=G.Layer.Html.extend({_placeHtml:function(e){var t=this,a=(G.MathUtil,G.Browser.getPxRatio()),r=(a[0],a[1],t._map),i=(r._rotate,r._res,t.options,G.DomUtil),o=t._zoomScale||t._scale,n=t._aroundScreen,l=r.toScreen(e.geom,n,o),s=l[0],_=l[1];t._hidden?i.hide(e):i.show(e),i.markPosTransform(e,s,_),i.updateTransform(e)},_onZoom:function(){var e=this,t=e._map;t._rotate,G.DomUtil;if(e._zooming)return e._tempScale==e._latestTempScale?void e._erase():void(e._latestTempScale=e._tempScale)},_onRotate:function(){var e=this;e._draw()},_onPinch:function(){var e=this;e._draw()}}),G.Layer.Image=G.Layer.Image.extend({_initContainer:function(){var e=this,t=e._map;e.addListener("imageSuccess",t._requestRedraw,t)},_destroyContainer:function(){var e=this,t=e._map;e.removeListener("imageSuccess",t._requestRedraw,t)},_update:function(){var e=this,t=e._map;t._isLoaded()&&e._draw()},_draw:function(){var e,t,a=this,r=a._map,i=a.options,o=a._ctx=r._useOffScreen?r._offScreenCtx:r._onScreenCtx,n=i.opacity<1;n&&(o.save(),o.globalAlpha=i.opacity);for(t in a._images)e=a._images[t],e._loaded&&a._placeImage(e);n&&o.restore()},_placeImage:function(e){if(e._loaded){var t=this,a=G.MathUtil,r=G.Browser.getPxRatio(),i=r[0],o=r[1],n=t._map,l=n._res,s=n._rotate,_=e.bbox,d=_[0],c=_[1],f=t._zoomScale||t._scale,u=t._aroundScreen,v=(_[2]-_[0])/l,h=(_[3]-_[1])/l;f&&1!==f&&(v/=f,h/=f);var g=n.toScreen([d,c],u,f),p=g[0],m=g[1],y=n._canvasOffset;p+=y[0],m+=y[1];var x=t._ctx;s&&(x.save(),x.translate(p,m),x.rotate(s/a.DEGREE_PER_RADIAN),x.translate(-p,-m));try{x.drawImage(e,p,m-h/o,v/i,h/o)}catch(C){}s&&x.restore()}},_onZoomStart:function(){},_onZoomUpdate:function(){},_onZoomEnd:function(){}}),G.Layer.Tile=G.Layer.Tile.extend({canvasFilter:{filters:["gray","dark","negative"],gray:function(e){for(var t=0,a=e.length;t<a;t+=4){var r=(e[t]+e[t+1]+e[t+2])/3;e[t]=e[t+1]=e[t+2]=r}},dark:function(e){for(var t=0,a=e.length;t<a;t+=4){var r=(e[t]+e[t+1]+e[t+2])/3;e[t]=e[t+1]=e[t+2]=255-r}},negative:function(e){for(var t=0,a=e.length;t<a;t+=4)e[t]=255-e[t],e[t+1]=255-e[t+1],e[t+2]=255-e[t+2]}},_initContainer:function(){var e=this,t=e._map;e.addListener("tileSuccess",t._requestRedraw,t),e.addListener("allLoaded",t._requestRedraw,t)},_destroyContainer:function(){var e=this,t=e._map;e.removeListener("tileSuccess",t._requestRedraw,t),e.removeListener("allLoaded",t._requestRedraw,t)},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var a,r,i,o,n,l,s,_,d,c,f,u=e._zoom=e._calcNearestZoom(!0),v=e._calcVisTileInfos(!0),h=(t.getSize(),t.getCenter()),g=e.options,p=g.zoomReses[u],m=g.tileSize,y=t.getDrawSize(),x=1+2*t.options.canvasExpandFactor,C=y[0]*x,w=y[1]*x,S=h[0]-C*p/2,D=h[0]+C*p/2,O=h[1]-w*p/2,L=h[1]+w*p/2,E=[S,O,D,L],R=t.options.maxExtent,b=g.filter=G.Util.trim(e.options.filter),T=e.canvasFilter.filters;e._redrawExtent=E;var P=G.ExtentUtil.intersect(E,R);b&&T.indexOf(b)<0&&(g.filter="",console.log("滤镜参数错误"));for(var M in e._tiles)i=e._tiles[M],o=i._info,a=o[0],r=o[1],n=o[2],f=g.zoomReses[n],n!==u&&(e._stopLoadingTile(i),(!g.keepResample||g.opacity<1)&&e._removeTile(M)),l=g.originX+a*m*f,s=g.originX+(a+1)*m*f,_=g.originY-(r+1)*m*f,d=g.originY-r*m*f,c=G.ExtentUtil.overlaps([l,_,s,d],P),c||e._tileInfoExist(o,v)||e._removeTile(M);var U=e._calcTileIndex(h[0],h[1],u);e._sortTileInfos(v,U[0],U[1]),e._addTiles(v),e._draw()}},_draw:function(){var e,t,a,r,i,o,n=this,l=n._map,s=n.options,_=n._ctx=l._useOffScreen?l._offScreenCtx:l._onScreenCtx,d=n._zoom,c=s.opacity<1;c&&(_.save(),_.globalAlpha=s.opacity);for(o in n._tiles)e=n._tiles[o],t=e._info,i=parseInt(t[2]),!e._loaded||i===d||!s.keepResample||s.opacity<1||(a=parseInt(t[0]),r=parseInt(t[1]),n._placeTile(e,a,r,i));for(o in n._tiles)e=n._tiles[o],t=e._info,i=parseInt(t[2]),e._loaded&&i===d&&(a=parseInt(t[0]),r=parseInt(t[1]),n._placeTile(e,a,r,i));c&&_.restore()},_placeTile:function(e,t,a,r){if(e._loaded){var i=Math.round,o=this,n=G.MathUtil,l=G.Browser.getPxRatio(),s=l[0],_=l[1],d=o._map,c=d._rotate,f=d._res,u=o.options,v=d.options,h=u.tileSize,g=u.zoomReses[r],p=h*g,m=u.tileEnlarge&&(!!(c%90)||G.Browser.gecko||G.Browser.safari),y=u.filter,x=(o.canvasFilter.filters,Math.ceil(p/f)+(m?2:0)),C=u.originX+t*p,w=u.originY-a*p,S=o._zoomScale||o._scale,D=o._aroundScreen;if(S&&1!==S&&(x/=S),!(x>4*(h+2)||x<h/8)){var O=0,L=0,E=v.maxExtent,R=E[2]-E[0];if(v.wrap){var b=o._redrawExtent;b&&E&&(L=Math.floor((b[0]-u.minX)/R)-1,O=Math.ceil((b[2]-u.maxX)/R)+1)}for(var T=L;T<=O;T++){var P=C+T*R,M=w,U=d.toScreen([P,M],D,S),I=U[0],A=U[1],W=d._canvasOffset;I+=W[0],A+=W[1],m&&(I-=1,A-=1),I=i(I),A=i(A);var k=o._ctx;c&&(k.save(),k.translate(I,A),k.rotate(c/n.DEGREE_PER_RADIAN),k.translate(-I,-A));try{var V=y?e._canvas:e;k.drawImage(V,I,A,i(x/s),i(x/_))}catch(N){}c&&k.restore()}}}},_addTiles:function(e){var t=this;if(0!==e.length){t._numLoad=e.length,t._numLoadSuccess=0,t._numLoadError=0;for(var a,r,i,o,n,l,s,_=t.options,d=(_.zoomReses.length,t.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE),c=0,f=e.length;c<f;c++)r=e[c],i=r[0],o=r[1],n=r[2],s=_.zoomReses[n],l=t._getTileName(i,o,n),a=t._tiles[l],a?a.src==d?+new Date-a._responseTime>_.tileLiveMs&&t._loadTile(a,i,o,n):t._numLoadSuccess++:(a=t._getIdleTile(),t._tiles[l]=a,t._loadTile(a,i,o,n));t._checkAllHandled()}},_onTileLoad:function(e){var t=e._layer;e._responseTime=+new Date;var a=t.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE;if(e.src!==a){if("naturalWidth"in e&&!e.naturalWidth){var r=e.src;e.src=a,t._numLoadError++,t.fireEvent("tileError",{tile:e,url:r})}else{G.DomUtil.addClass(e,"g-tile-loaded"),e._loaded=!0;var i=this.options.filter;if(i){var o=G.DomUtil.create("canvas"),n=o.getContext("2d"),l=G.Browser.getCanvasRatio(),s=o.width=256*l[0],_=o.height=256*l[1];n.drawImage(e,0,0,s,_);var d=n.getImageData(0,0,s,_),c=d.data;this.canvasFilter[i](c),n.putImageData(d,0,0),e._canvas=n.canvas}t._numLoadSuccess++,t.fireEvent("tileSuccess",{tile:e,url:e.src})}t._checkAllHandled()}},_clearBgBuffer:function(){var e,t,a,r=this;for(var i in r._tiles)e=r._tiles[i],t=e._info,a=t[2],a!==r._zoom&&r._removeTile(i)}}),G.Layer.Label=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{icons:"",cluster:[],crossOrigin:"*"},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e,a.options=G.Util.merge({},a.options,t),a._lts={},a._gx=a._gy=10},_initContainer:function(){var e=this;G.Layer.Graphic.prototype._initContainer.call(e)},_onAdded:function(){var e=this;e._container||e._initContainer()},_onRemoved:function(){var e=this;e._container&&e._destroyContainer()},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded()){var a=e._zoom=e._calcNearestZoom(!0),r=t.getCenter();e._clearGrids();var i=t._zoomAnim;if(i&&i._playing);else{var o=e._calcVisTileInfos(),n=e._calcTileIndex(r[0],r[1],a);e._sortTileInfos(o,n[0],n[1]),e._setLts(o)}}},_setLts:function(e){var t=this;if(e.length){for(var a,r,i,o,n,l,s=[],_=0,d=e.length;_<d;_++)i=e[_],o=i[0],n=i[1],l=i[2],a=t._getTileName(o,n,l),s.push(a),a in t._lts?(r=t._lts[a],r.loading||r.data||r.ri||t._loadLtI(o,n,l)):t._loadLtI(o,n,l),t._placeLt(a);t._dirtyTileKeys=t._dirtyTileKeys||[];for(a in t._lts)s.indexOf(a)>-1||(t._stopLoadingLt(a),t._dirtyTileKeys.push(a))}},_checkDirtyTiles:function(){var e,t=this,a=t._dirtyTileKeys;if(a&&a.length>0)for(var r=0,i=a.length;r<i;r++)e=a[r],t._removeLt(e);t._dirtyTileKeys=[]},_placeLt:function(e){var t=this,a=t._lts[e];if(a&&a._info&&a.data){var r,i,o,n,l,s,_,d,c,f,u,v,h,g,p,m,y,x,C,w,S=a.data.l;for(r in S){i=S[r],o=Number(i[0]),n=Number(i[1]),l=Number(i[2]),s=Number(i[3]),_=Number(i[4]),d=Number(i[5]),c=i[6],m=[o,n],y="imgs"+r,x=a[y];for(C in x)f=x[C],u=f[0],v=f[1],h=f[2],g=f[3],p=f[4],w=f[5],w||(f[5]=w=new G.Graphic.Point(m,null,{shape:"image",size:[v,h],offset:[g,p],image:u,imageGravity:!!c}),w.addTo(t))}}},_removeLt:function(e){var t=this,a=t._lts[e];if(a&&a._info&&a.data){t._stopLoadingLt(e);var r,i,o,n,l,s=a.data.l;for(r in s){o="imgs"+r,n=a[o];for(l in n)i=n[l],g=i[5],g&&g.remove()}delete t._lts[e]}},_loadLtI:function(e,t,a){var r=this,i=r._getTileName(e,t,a),o=r._lts[i]=r._lts[i]||{};if(o._info=[e,t,a],""!==o.data){o.loading=!0;var n=r._getTileUrl(e,t,a,{d:"i",i:G.Browser.retina?"@2x":""}),l={};r.options.crossOrigin&&(l.crossOrigin=r.options.crossOrigin);var s={responseType:"http"===n.slice(0,4).toLowerCase()?"JSONP":"JSON",header:l,success:function(e,t){o.data=t,r._processLt(i)},error:function(e){404==e.status&&(o.data="")},complete:function(){delete o.ri,o.loading=!1}};r.options.crossOrigin&&(s.responseType="JSON");var _=G.Util.ajax(n,s);o.ri=_}},_processLt:function(e){var t=this,a=t._lts[e],r=a.data;if(r){var i,o,n,l,s,_,d,c,f,u,v,h,g,p,m,y,x,G,C,w,S,D=r.l,O=r.b,L=r.i,E=r.bb,R=t.options.icons||"";for(o in D){if(i=D[o],n=Number(i[0]),l=Number(i[1]),s=i[6],O&&o in O)for(g=O[o],w=0,S=g.length;w<S;w++)p=g[w],_=p[0],d=p[1],c=p[2],f=p[3],u=p[4],v=p[5],0!=v&&E&&(x=E.slice(u,u+v),G="data:image/png;base64,"+x,C="b"+w,a["imgs"+o]=a["imgs"+o]||{},a["imgs"+o][C]=[G,_,d,c,f]);if(L&&o in L)for(m=L[o],w=0,S=m.length;w<S;w++)y=m[w],_=y[0],d=y[1],c=y[2],f=y[3],h=y[4],G=R+h,C="i"+w,a["imgs"+o]=a["imgs"+o]||{},a["imgs"+o][C]=[G,_,d,c,f]}t._checkDirtyTiles(),t._placeLt(e)}},_stopLoadingLt:function(e){var t=this._lts[e],a=G.Util.ajaxCancel;t&&(a(t.ri),t.loading=!1)},_onIconLoad:function(){this._dirtyIcons=!0},_clearGrids:function(){this._g={}},_hitGrids:function(e,t,a,r){for(var i,o=this,n=e;n<=a;n++)for(var l=t;l<=r;l++)if(i=n+","+l,o._g[i])return!0;return!1},_markGrids:function(e,t,a,r){for(var i,o=this,n=e;n<=a;n++)for(var l=t;l<=r;l++)i=n+","+l,o._g[i]=!0}}),G.Layer.VectorCache=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{cluster:[]},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e,a.options=G.Util.merge({},a.options,t),a._vts={},a._visVtKeys=[],a._vIds={}},_initContainer:function(){var e=this;G.Layer.Graphic.prototype._initContainer.call(e)},_onAdded:function(){var e=this;e._container||e._initContainer()},_onRemoved:function(){var e=this;e._container&&e._destroyContainer()},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded()){var a=e._calcVisTileInfos();e._addVts(a)}},_addVts:function(e){var t=this;if(0!==e.length){var a,r,i,o,n,l,s,_,d=[];for(a=0,r=e.length;a<r;a++)n=e[a],l=n[0],s=n[1],_=n[2],i=t._getTileName(l,s,_),d.push(i),i in t._vts?(o=t._vts[i],o.data&&t._processVt(i)):t._loadVt(l,s,_);for(a=0,r=t._visVtKeys.length;a<r;a++)i=t._visVtKeys[a],d.indexOf(i)<0&&t._removeVt(i);t._visVtKeys=d}},_removeVt:function(e){var t=this,a=t._vts[e];a&&t._stopLoadingVt(e)},_loadVt:function(e,t,a){var r=this,i=r._getTileName(e,t,a),o=r._vts[i]=r._vts[i]||{};if(o._info=[e,t,a],""!==o.data){o.loading=!0;var n=r._getTileUrl(e,t,a,{d:"f"}),l={responseType:"http"===n.slice(0,4).toLowerCase()?"JSONP":"JSON",success:function(e,t){o.data=t,r._processVt(i)},error:function(e){404==e.status&&(o.data="")},complete:function(){delete o.req,o.loading=!1}},s=G.Util.ajax(n,l);o.req=s}},_processVt:function(e){for(var t,a,r,i,o,n,l,s,_,d=this,c=d._map,f=d._vts[e],u=f.data,v=u.v,h=u.s,g=G.Util.colorHex,p=0,m=v.length;p<m;p++)t=v[p],a=t.id,r=t.g,i=t.gt,o=t.st,n=h[o],l=d._vIds[a],l?l._updateGeom(r):"pt"===i?l=new G.Graphic.Point(r):"pl"===i?l=new G.Graphic.Polyline(r):"pg"===i&&(l=new G.Graphic.Polygon(r)),l&&(_=l.options,"pt"===i||"pl"===i&&(s=n.line_color,_.lineWidth=n.line_width,_.lineColor=g(s[0],s[1],s[2])),l&&(l.addTo(d),l._vtKeys=l._vtKeys||{},l._vtKeys[e]=!0,d._vIds[a]=l));c._requestRedraw()},_stopLoadingVt:function(e){var t=this._vts[e],a=G.Util.ajaxCancel;t&&(a(t.req),t.loading=!1)}}),G.Layer.FeatureService=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{mode:"all",vacuumCount:1e3},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.options=G.Util.merge({},a.options,t),a._reqFunc=e,a._loadingKeys={}},onSuccess:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileSuccess",{extent:e}):t.fireEvent("loadAllSuccess")},onError:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileError",{extent:e}):t.fireEvent("loadAllError")},onComplete:function(e){var t=this;if("tile"==t.options.mode){var a=e.join(",");delete t._loadingKeys[a],t.fireEvent("loadTileComplete",{extent:e})}else t.fireEvent("loadAllComplete")},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())if("tile"==e.options.mode){var a=e.count();a>e.options.vacuumCount&&e._vacuum();var r=e._calcVisTileInfos();e._addFts(r)}else e._loadAll()},_addFts:function(e){var t=this;if(0!==e.length){var a,r,i,o,n,l,s,_,d,c=t._loadingKeys,f={};for(a=0,r=e.length;a<r;a++)n=e[a],l=n[0],s=n[1],_=n[2],d=t._calcTileExtent(l,s,_),i=d.join(","),f[i]=d;for(i in c)f[i]||(o=c[i],G.Util.ajaxCancel(o),delete c[i]);for(i in f)d=f[i],t._loadFt(d)}},_loadFt:function(e){var t=this,a=e.join(","),r=t._reqFunc;if(!(a in t._loadingKeys)&&r){var i=r.call(t,e);t._loadingKeys[a]=i,t.fireEvent("loadTileStart",{extent:e})}},_loadAll:function(){var e=this,t="all",a=e._reqFunc;if(!(t in e._loadingKeys)&&a){var r=a.call(e);e._loadingKeys[t]=r,e.fireEvent("loadAllStart")}}}),G.Layer.GeoHeyFeature=G.Layer.FeatureService.extend({options:{apiKey:"",where:"1=1",outFields:"",limit:1e3},init:function(e,t){var a=this,r=function(t){var r=e+"/query",i=a.options,o={ak:i.apiKey,where:i.where,outFields:i.outFields,limit:i.limit};t&&(o.geometry=JSON.stringify(t));var n={responseType:"http"===r.slice(0,4).toLowerCase()?"JSONP":"JSON",data:o,success:function(e,r){var o=r.data,n=o.geometryType,l=o.features;if(l){var s,_,d,c,f,u,v,h,g=l.length-1,p=Math.max(0,g-i.limit),m=[];for(s=g;s>=p;s--){_=l[s],d=_.id,c=_.geom,f=_.attrs||{},"Point"==n?m.push(new G.Graphic.Point(c,f)):"Polyline"==n?m.push(new G.Graphic.Polyline(c,f)):"Polygon"==n?m.push(new G.Graphic.Polygon(c,f)):"MultiPoint"==n?m.push(new G.Graphic.MultiPoint(c,f)):"MultiPolyline"==n?m.push(new G.Graphic.MultiPolyline(c,f)):"MultiPolygon"==n&&m.push(new G.Graphic.MultiPolygon(c,f));for(v in m)h=m[v],h&&(u=d+"_"+v,a.get(u)||h.addTo(a,u))}}a.onSuccess(t)},error:function(){a.onError(t)},complete:function(){a.onComplete(t)}};G.Util.ajax(r,n)};G.Layer.FeatureService.prototype.init.call(a,r,t)}}),G.Layer.GeoHeyProgressiveFeature=G.Layer.Graphic.extend({options:{stepFactor:4,stepCount:4,tolerance:8,outFields:"[]"},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e},onSuccess:function(e){this.fireEvent("extentSuccess",{extent:e})},onError:function(e){this.fireEvent("extentError",{extent:e})},onComplete:function(e){var t=this;t.fireEvent("extentComplete",{extent:e})},_update:function(){var e=this,t=e._map,a=e._loadRes=t._res,r=e._loadExtent=t.getExtent(),i=e._loadedStatus;if((!i||a!=i[0]||!G.ExtentUtil.equals(r,i[1]))&&(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())){var o=e._req;o&&G.Util.ajaxCancel(o);var n,l,s=e._graphics;for(l in s)n=s[l],n._dirty=!0;e._loadStep(1)}},_loadStep:function(e){var t=this,a=t.options,r=t._loadRes,i=t._loadExtent,o=a.tolerance*Math.pow(a.stepFactor,a.stepCount-e),n=t.url+"/filter",l={responseType:"JSON",data:{extent:JSON.stringify(i),excludeExtents:JSON.stringify([]),res:r,cellPixel:o,outFields:a.outFields},success:function(a,r){t._processResult(e,r)},complete:function(){t._req=null}};t._req=G.Util.ajax(n,l)},_processResult:function(e,t){var a=this,r=a.options,i=a._loadRes,o=a._loadExtent,n=r.tolerance*Math.pow(r.stepFactor,r.stepCount-e),l=i*n,s=t.geometryType,_=t.features;if(!_)return a.onError(o),void a.onComplete(o);var d,c,f,u,v,h,g,p,m=_.length-1;for(d=m;d>=0;d--)if(c=_[d],f=c.id,u=c.geom,v=c.attrs||{},"Point"==s)p=new G.Graphic.Point(u,v),a._updateGraphic(l,f,0,p);else if("Polyline"==s)p=new G.Graphic.Polyline(u,v),a._updateGraphic(l,f,0,p);else if("Polygon"==s)p=new G.Graphic.Polygon(u,v),a._updateGraphic(l,f,0,p);else if("MultiPoint"==s)for(h in u.multi)g=u.multi[h],p=new G.Graphic.Point(g,v),a._updateGraphic(l,f,h,p);else if("MultiPolyline"==s)for(h in u.multi)g=u.multi[h],p=new G.Graphic.Polyline(g,v),a._updateGraphic(l,f,h,p);else if("MultiPolygon"==s)for(h in u.multi)g=u.multi[h],p=new G.Graphic.Polygon(g,v),a._updateGraphic(l,f,h,p);e<r.stepCount?a._loadStep(e+1):(a._clearDirty(),a._loadedStatus=[i,o],a.onSuccess(o),a.onComplete(o))},_updateGraphic:function(e,t,a,r){var i=this,o=t+(a?"_"+a:""),n=i.get(o);n?(e<n._res&&(n.updateGeom(r.geom,!0),n._res=e),n._dirty=!1):(r._res=e,r.addTo(i,o))},_clearDirty:function(){var e,t,a=this,r=a._graphics;for(t in r)e=r[t],e._dirty&&e.remove()}}),G.Layer.TiledService=G.Layer.extend({mixins:[G.Layer.LOD],init:function(e,t){var a=this;a.options=G.Util.merge({},a.options,t),a._reqFunc=e,a._loadingKeys={},a._loadedKeys={}},onSuccess:function(e,t){var a=this;a._numLoadSuccess++;var r=parseInt(e[0]),i=parseInt(e[1]),o=parseInt(e[2]),n=a._getTileName(r,i,o);a._loadedKeys[n]=e,a.fireEvent("loadTileSuccess",{tileInfo:e,data:t})},onError:function(e){var t=this;t._numLoadError++,t.fireEvent("loadTileError",{tileInfo:e})},onComplete:function(e){var t=this,a=parseInt(e[0]),r=parseInt(e[1]),i=parseInt(e[2]),o=t._getTileName(a,r,i);delete t._loadingKeys[o],t.fireEvent("loadTileComplete",{tileInfo:e}),t._checkAllHandled()},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var a,r,i,o,n,l,s,_=e._calcVisTileInfos(),d={};for(a=0,r=_.length;a<r;a++)o=_[a],n=o[0],l=o[1],s=o[2],i=e._getTileName(n,l,s),d[i]=o;e._addTiles(d);for(i in e._loadedKeys)d[i]||(o=e._loadedKeys[i],delete e._loadedKeys[i],e.fireEvent("unusedTile",{tileInfo:o}));e._onUpdated()}},_addTiles:function(e){var t,a,r,i=this,o=i._loadingKeys;for(t in o)e[t]||(a=o[t],G.Util.ajaxCancel(a),delete o[t]);i._numLoad=Object.keys(e).length,i._numLoadSuccess=0,i._numLoadError=0;for(t in e)r=e[t],i._loadTile(r);i._checkAllHandled()},_loadTile:function(e){var t=this,a=t._reqFunc,r=parseInt(e[0]),i=parseInt(e[1]),o=parseInt(e[2]),n=t._getTileName(r,i,o);if(!(n in t._loadingKeys)&&a){if(n in t._loadedKeys)return void t._numLoadSuccess++;var l=a.call(t,r,i,o);t._loadingKeys[n]=l,t.fireEvent("loadTileStart",{tileInfo:e})}},_stopLoadingByKey:function(e){var t=this._loadingKeys,a=t[e];a&&(G.Util.ajaxCancel(a),delete t[e])},_checkAllHandled:function(){var e=this;e._numLoad==e._numLoadSuccess+e._numLoadError&&e.fireEvent("allLoaded")},_onUpdated:function(){}}),G.Layer.UTFGrid=G.Layer.TiledService.extend({mixins:[G.Layer.LOD],options:{showAttr:!0,pos:"right"},init:function(e,t){var a=this;a.url=e,a.options=G.Util.merge({},a.options,t),a._tiles={},a._dirtyTiles={};var r=function(e,t,r){var i,o=a._getTileName(e,t,r),n=a._getTileUrl(e,t,r),l=[e,t,r];G.Util.ajax(n,{responseType:"jsonp",success:function(e,t){return a.onSuccess(l,t),!(!t||!t.data||1==t.data.keys.length&&""==t.data.keys[0])&&(a._tiles[o]=t.data,i=a._map,void(i&&i._requestRedraw()))},error:function(e){a.onError(l)},complete:function(e){a.onComplete(l)}})};if(a.options.showAttr){var i=document.getElementsByClassName("g-layers-frame");a._board=document.createElement("div"),a._board.className="g-utf-board",i[0].appendChild(a._board)}a._pos="left"==a.options.pos?-1:0,G.Layer.TiledService.prototype.init.call(a,r,a.options)},_onAdded:function(){var e=this,t=e._map;t.addListener("mousemove",e._onMouseMove,e),e.addListener("unusedTile",e._onUnusedTile,e)},_onRemoved:function(){var e=this,t=e._map;t.removeListener("mousemove",e._onMouseMove,e),e.removeListener("unusedTile",e._onUnusedTile,e)},_onMouseMove:function(e){var t=this,a=t._map;if(t.isVisible()){var r=a._res,i=(e.mapX-t.options.originX)/r,o=(t.options.originY-e.mapY)/r,n=t._calcNearestZoom(),l=t._calcTileExtent(0,0,n),s=(l[2]-l[0])/r,_=s/256,d=4*_,c=Math.floor(i/s),f=Math.floor(o/s),u=Math.floor((i-c*s)/d),v=Math.floor((o-f*s)/d),h=[c,f,n],g=t.getData(h,u,v),p=[e.screenX,e.screenY];t.options.showAttr&&t.showData(g,p),t.fireEvent("gridMouseMove",{data:g,point:p})}},_onUnusedTile:function(e){var t=this,a=e.tileInfo,r=t._getTileName(a[0],a[1],a[2]);delete t._tiles[r]},getData:function(e,t,a){var r=this,i=r._getTileName(e[0],e[1],e[2]),o=r._tiles[i];if(o&&o.grid){var n=this._decode(o.grid[a].charCodeAt(t));return i=o.keys[n],o.data[i]}},_decode:function(e){return e>=93&&e--,e>=35&&e--,e-32},showData:function(e,t){var a=this;if(e){var r="";for(var i in e){var o=i+": "+e[i]+"\r";r+=o}var n=a._board.clientHeight,l=a._board.clientWidth;a._board.innerHTML=r,a._board.style.left=t[0]+(l+30)*a._pos+15+"px",a._board.style.top=t[1]-n/2+"px",a._board.style.display="block"}else a._board.style.display="none"}}),G.Graphic.Arrow=G.Graphic.Arrow.extend({_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx;e._updateGeomDraw(r._res);var o,n,l,s=e._geomDraw,_=r._canvasOffset,d=e.bbox,c=(d[0]+d[2])/2,f=(d[1]+d[3])/2,u=r._calcWrapPointRange([c,f])||[0,0],v=r.options.maxExtent,h=v[2]-v[0];i.save();for(var g=u[0];g<=u[1];g++){i.beginPath();for(var p=0,m=s.length;p<m;p++){n=s[p];for(var y=0,x=n.length;y<x;y++)l=n[y],l=r.toScreen([l[0]+g*h,l[1]]),o=0===y?"moveTo":"lineTo",i[o](l[0]+_[0],l[1]+_[1]);l=n[0],l=r.toScreen([l[0]+g*h,l[1]]),i.lineTo(l[0]+_[0],l[1]+_[1])}if(t.fill){if(t.fillImage){var C=G.Browser.getImageSrc(t.fillImage),w=G.DomUtil.getImgElement(C,function(){r._requestRedraw()},null,"*");w._loaded?(i.fillStyle=i.createPattern(w,"repeat"),i.globalAlpha=t.fillOpacity):i.globalAlpha=0}else i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity;i.fill()}(t.outline||e._mouseOver||e._editing)&&(i.strokeStyle=e._editing?t.lineHighlightColor:t.outline?t.outlineColor:t.fillColor,i.lineCap=t.outlineCap,i.lineJoin=t.outlineJoin,i.lineWidth=(t.outline?t.outlineWidth:0)+(e._mouseOver?t.lineHighlightWiden:0),i.globalAlpha=t.outlineOpacity,G.Util.setCanvasLineDash(i,t.outlineDashArray),i.stroke())}i.restore()},_drawMask:function(){var e=this,t=e._map,a=t._maskCtx;e._updateGeomDraw(t._res);var r,i,o,n=e._geomDraw,l=t._canvasOffset,s=e.bbox,_=(s[0]+s[2])/2,d=(s[1]+s[3])/2,c=t._calcWrapPointRange([_,d])||[0,0],f=t.options.maxExtent,u=f[2]-f[0];a.beginPath();for(var v=c[0];v<=c[1];v++)for(var h=0,g=n.length;h<g;h++){i=n[h];for(var p=0,m=i.length;p<m;p++)o=i[p],o=t.toScreen([o[0]+v*u,o[1]]),r=0===p?"moveTo":"lineTo",a[r](o[0]+l[0],o[1]+l[1]);o=i[0],o=t.toScreen([o[0]+v*u,o[1]]),a.lineTo(o[0]+l[0],o[1]+l[1])}a.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Circle=G.Graphic.Circle.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=r._res,n=e.geom,l=n[0],s=n[1],_=n[2],d=_/o,c=r._canvasOffset,f=r._calcWrapPointRange(n)||[0,0],u=r.options.maxExtent,v=u[2]-u[0];i.save();for(var h=f[0];h<=f[1];h++){var g=r.toScreen([l+h*v,s]);if(g[0]+=c[0],g[1]+=c[1],i.beginPath(),i.arc(g[0],g[1],d,0,2*Math.PI),t.fill){if(t.fillImage){var p=G.Browser.getImageSrc(t.fillImage),m=G.DomUtil.getImgElement(p,function(){r._requestRedraw()},null,"*");m._loaded?(i.fillStyle=i.createPattern(m,"repeat"),i.globalAlpha=t.fillOpacity):i.globalAlpha=0}else if(t.gradual){var y=i.createRadialGradient(g[0],g[1],0,g[0],g[1],d),x=G.Util.colorRgb(t.fillColor);y.addColorStop(0,t.fillColor),y.addColorStop(1,"rgba("+x[0]+","+x[1]+","+x[2]+","+t.fillOpacity+")"),i.fillStyle=y}else i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity;i.fill()}(t.outline||e._mouseOver)&&(i.strokeStyle=e._editing?t.lineHighlightColor:t.outlineColor,i.lineWidth=e._mouseOver?t.outlineWidth+t.lineHighlightWiden:t.outlineWidth,i.globalAlpha=t.outlineOpacity,G.Util.setCanvasLineDash(i,t.outlineDashArray),i.stroke())}i.restore()},_drawMask:function(){var e=this,t=e._map,a=t._maskCtx,r=t._res,i=e.geom,o=i[0],n=i[1],l=i[2],s=l/r,_=t._canvasOffset,d=t._calcWrapPointRange(i)||[0,0],c=t.options.maxExtent,f=c[2]-c[0];a.beginPath();for(var u=d[0];u<=d[1];u++){var v=t.toScreen([o+u*f,n]);v[0]+=_[0],v[1]+=_[1],a.arc(v[0],v[1],s,0,2*Math.PI,!1)}a.fill()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Group=G.Graphic.Group.extend({_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPoint=G.Graphic.MultiPoint.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=Math.round,n=t.shape,l=t.size,s=l[0],_=l[1],d=t.offset,c=t.imageRotate;t.imageGravity||(c+=r._rotate),"image"==n&&c&&(d=G.MathUtil.rotateVector(d,c));for(var f,u,v,h=e.geom.m,g=r._canvasOffset,p=e.bbox,m=(p[0]+p[2])/2,y=(p[1]+p[3])/2,x=r._calcWrapPointRange([m,y])||[0,0],C=r.options.maxExtent,w=C[2]-C[0],S=x[0];S<=x[1];S++)for(var D=0;D<h.length;D++)if(f=h[D],f=r.toScreen([f[0]+S*w,f[1]]),u=f[0]+d[0]+g[0],v=f[1]+d[1]+g[1],"rect"==n)i.beginPath(),i.rect(u-s/2,v-_/2,s,_),e._renderPath(u,v,Math.max(s/2,_/2));else if("image"==n){var O=G.Browser.getImageSrc(t.image),L=G.DomUtil.getImgElement(O,function(){r._requestRedraw()});L._loaded&&(i.save(),i.translate(o(u),o(v)),i.rotate(c/G.MathUtil.DEGREE_PER_RADIAN),i.drawImage(L,0,0,s,_),i.restore())}else if("text"==n){i.save(),i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity,i.font=t.textStyle+" "+s+"px "+t.textFont,i.textAlign=t.textAlign,i.textBaseline="middle";var E=t.text;if(!e._textMeasureWidth||e._textMeasure!=E){var R=i.measureText(E);e._textMeasureWidth=R.width,e._textMeasure=E}i.fillText(E,u,v),i.restore()}else i.beginPath(),i.arc(u,v,s/2,0,2*Math.PI),e._renderPath(u,v,s/2)},_renderPath:function(e,t,a){var r,i,o=this,n=o._layer,l=n._map,s=n._ctx,_=o.options;if(s.save(),_.fill){if(_.fillImage)r=G.Browser.getimgSrc(_.fillImage),i=G.DomUtil.getImgElement(r,function(){l._requestRedraw()}),i._loaded?(s.fillStyle=s.createPattern(i,"repeat"),s.globalAlpha=_.fillOpacity):s.globalAlpha=0;else if(_.gradual){var d=s.createRadialGradient(e,t,0,e,t,a),c=G.Util.colorRgb(_.fillColor);d.addColorStop(0,_.fillColor),d.addColorStop(1,"rgba("+c[0]+","+c[1]+","+c[2]+","+_.fillOpacity+")"),s.fillStyle=d}else s.fillStyle=_.fillColor,s.globalAlpha=_.fillOpacity;s.fill()}(_.outline||o._mouseOver||o._editing)&&(s.strokeStyle=o._editing?_.lineHighlightColor:_.outline?_.outlineColor:_.fillColor,s.lineWidth=o._mouseOver?_.outlineWidth+_.lineHighlightWiden:_.outlineWidth,s.globalAlpha=_.outlineOpacity,G.Util.setCanvasLineDash(s,_.outlineDashArray),s.stroke()),s.restore()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging&&!e.options.allowPan,a._requestRedraw(),e._isVertex?r.addClass(a._layersFrame,"g-edit"):r.addClass(a._layersFrame,"g-clickable")}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging,a._requestRedraw(),e._isVertex?r.removeClass(a._layersFrame,"g-edit"):r.removeClass(a._layersFrame,"g-clickable")}}}),G.Graphic.MultiPolygon=G.Graphic.MultiPolygon.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r,i=this,o=i.options,n=i._layer,l=n._map,s=n._ctx,_=i.geom.m,d=l._canvasOffset,c=i.bbox,f=(c[0]+c[2])/2,u=(c[1]+c[3])/2,v=l._calcWrapPointRange([f,u])||[0,0],h=l.options.maxExtent,g=h[2]-h[0];s.save(),s.beginPath();for(var p=v[0];p<=v[1];p++)for(var m=0,y=_.length;m<y;m++){e=_[m];for(var x=0,C=e.length;x<C;x++){a=e[x];for(var w=0,S=a.length;w<S;w++)r=a[w],r=l.toScreen([r[0]+p*g,r[1]]),t=0===w?"moveTo":"lineTo",s[t](r[0]+d[0],r[1]+d[1]);r=a[0],r=l.toScreen([r[0]+p*g,r[1]]),s.lineTo(r[0]+d[0],r[1]+d[1])}}if(o.fill){if(o.fillImage){var D=G.Browser.getImageSrc(o.fillImage),O=G.DomUtil.getImgElement(D,function(){l._requestRedraw()},null,"*");O._loaded?(s.fillStyle=s.createPattern(O,"repeat"),s.globalAlpha=o.fillOpacity):s.globalAlpha=0}else s.fillStyle=o.fillColor,s.globalAlpha=o.fillOpacity;s.fill()}(o.outline||i._mouseOver||i._editing)&&(s.strokeStyle=i._editing?o.lineHighlightColor:o.outline?o.outlineColor:o.fillColor,s.lineCap=o.outlineCap,s.lineJoin=o.outlineJoin,s.lineWidth=(o.outline?o.outlineWidth:0)+(i._mouseOver?o.lineHighlightWiden:0),s.globalAlpha=o.outlineOpacity,G.Util.setCanvasLineDash(s,o.outlineDashArray),s.stroke()),s.restore()},_drawMask:function(){var e,t,a,r,i=this,o=i._map,n=o._maskCtx,l=i.geom.m,s=o._canvasOffset,_=i.bbox,d=(_[0]+_[2])/2,c=(_[1]+_[3])/2,f=o._calcWrapPointRange([d,c])||[0,0],u=o.options.maxExtent,v=u[2]-u[0];n.beginPath();for(var h=f[0];h<=f[1];h++)for(var g=0,p=l.length;g<p;g++){e=l[g];for(var m=0,y=e.length;m<y;m++){a=e[m];for(var x=0,G=a.length;x<G;x++)r=a[x],r=o.toScreen([r[0]+h*v,r[1]]),t=0===x?"moveTo":"lineTo",n[t](r[0]+s[0],r[1]+s[1]);r=a[0],r=o.toScreen([r[0]+h*v,r[1]]),n.lineTo(r[0]+s[0],r[1]+s[1])}}n.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPolyline=G.Graphic.MultiPolyline.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r=this,i=r.options,o=r._layer,n=o._map,l=o._ctx,s=r.geom.m,_=n._canvasOffset,d=r.bbox,c=(d[0]+d[2])/2,f=(d[1]+d[3])/2,u=n._calcWrapPointRange([c,f])||[0,0],v=n.options.maxExtent,h=v[2]-v[0];
l.save(),l.beginPath();for(var g=u[0];g<=u[1];g++)for(var p=0,m=s.length;p<m;p++){e=s[p];for(var y=0,x=e.length;y<x;y++)a=e[y],a=n.toScreen([a[0]+g*h,a[1]]),t=0===y?"moveTo":"lineTo",l[t](a[0]+_[0],a[1]+_[1])}l.strokeStyle=r._editing?i.lineHighlightColor:i.lineColor,l.lineCap=i.lineCap,l.lineJoin=i.lineJoin,l.lineWidth=r._mouseOver?i.lineWidth+i.lineHighlightWiden:i.lineWidth,l.globalAlpha=i.lineOpacity,G.Util.setCanvasLineDash(l,i.lineDashArray),l.stroke(),l.restore()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.OD=G.Graphic.OD.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=e.geom,n=r._canvasOffset,l=e.bbox,s=(l[0]+l[2])/2,_=(l[1]+l[3])/2,d=r._calcWrapPointRange([s,_])||[0,0],c=r.options.maxExtent,f=c[2]-c[0];i.save(),i.strokeStyle=e._editing?t.lineHighlightColor:t.lineColor,i.lineCap=t.lineCap,i.lineJoin=t.lineJoin,i.lineWidth=e._mouseOver?t.lineWidth+t.lineHighlightWiden:t.lineWidth,i.globalAlpha=t.lineOpacity,i.shadowBlur=1==t.shadow?4:0,i.shadowColor=1==t.shadow?t.shadowColor:"",G.Util.setCanvasLineDash(i,e.options.lineDashArray),i.beginPath();for(var u,v=d[0];v<=d[1];v++){var h=t.animating,g=h?t.endGeom:o[1],p=r.toScreen([o[0][0]+v*f,o[0][1]]);i.moveTo(p[0]+n[0],p[1]+n[1]),u=g[0]!=o[0][0]?h?Math.round((o[1][0]-o[0][0])/(g[0]-o[0][0])*100):100:h?Math.round((o[1][1]-o[0][1])/(g[1]-o[0][1])*100):100;for(var m=[],y=0;y<=100;y++)m.push(r.toScreen([e._odLines[y][0]+v*f,e._odLines[y][1]]));for(var x=0;x<=u;x++)i.lineTo(m[x][0]+n[0],m[x][1]+n[1])}i.stroke(),i.restore()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")},_onStartEdit:function(){return this._editing=!1,!1}}),G.Graphic.Point=G.Graphic.Point.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=Math.round,n=t.shape,l=t.size,s=l[0],_=l[1],d=t.offset,c=t.imageRotate;t.imageGravity||(c+=r._rotate),"image"==n&&c&&(d=G.MathUtil.rotateVector(d,c));for(var f=e.geom[0],u=e.geom[1],v=r._canvasOffset,h=r._calcWrapPointRange(e.geom)||[0,0],g=r.options.maxExtent,p=g[2]-g[0],m=h[0];m<=h[1];m++){var y=r.toScreen([f+m*p,u]),x=y[0]+d[0],C=y[1]+d[1];if(x+=v[0],C+=v[1],"rect"==n)i.beginPath(),i.rect(x-s/2,C-_/2,s,_),e._renderPath(x,C,Math.max(s/2,_/2));else if("image"==n){var w=G.Browser.getImageSrc(t.image),S=G.DomUtil.getImgElement(w,function(){r._requestRedraw()});S._loaded&&(i.save(),i.translate(o(x),o(C)),i.rotate(c/G.MathUtil.DEGREE_PER_RADIAN),i.drawImage(S,0,0,s,_),i.restore())}else if("text"==n){i.save(),i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity,i.font=t.textStyle+" "+s+"px "+t.textFont,i.textAlign=t.textAlign,i.textBaseline="middle";var D=t.text;if(!e._textMeasureWidth||e._textMeasure!=D){var O=i.measureText(D);e._textMeasureWidth=O.width,e._textMeasure=D}i.fillText(D,x,C),i.restore()}else i.beginPath(),i.arc(x,C,s/2,0,2*Math.PI),e._renderPath(x,C,s/2)}},_renderPath:function(e,t,a){var r,i,o=this,n=o._layer,l=n._map,s=n._ctx,_=o.options;if(s.save(),_.fill){if(_.fillImage)r=G.Browser.getimgSrc(_.fillImage),i=G.DomUtil.getImgElement(r,function(){l._requestRedraw()}),i._loaded?(s.fillStyle=s.createPattern(i,"repeat"),s.globalAlpha=_.fillOpacity):s.globalAlpha=0;else if(_.gradual){var d=s.createRadialGradient(e,t,0,e,t,a),c=G.Util.colorRgb(_.fillColor);d.addColorStop(0,_.fillColor),d.addColorStop(1,"rgba("+c[0]+","+c[1]+","+c[2]+","+_.fillOpacity+")"),s.fillStyle=d}else s.fillStyle=_.fillColor,s.globalAlpha=_.fillOpacity;s.fill()}(_.outline||o._mouseOver||o._editing)&&(s.strokeStyle=o._editing?_.lineHighlightColor:_.outline?_.outlineColor:_.fillColor,s.lineWidth=o._mouseOver?_.outlineWidth+_.lineHighlightWiden:_.outlineWidth,s.globalAlpha=_.outlineOpacity,G.Util.setCanvasLineDash(s,_.outlineDashArray),s.stroke()),s.restore()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging&&!e.options.allowPan,a._requestRedraw(),e._isVertex?r.addClass(a._layersFrame,"g-edit"):r.addClass(a._layersFrame,"g-clickable")}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging,a._requestRedraw(),e._isVertex?r.removeClass(a._layersFrame,"g-edit"):r.removeClass(a._layersFrame,"g-clickable")}}}),G.Graphic.Polygon=G.Graphic.Polygon.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r=this,i=r.options,o=r._layer,n=o._map,l=o._ctx,s=r.geom,_=n._canvasOffset,d=r.bbox,c=(d[0]+d[2])/2,f=(d[1]+d[3])/2,u=n._calcWrapPointRange([c,f])||[0,0],v=n.options.maxExtent,h=v[2]-v[0];l.save();for(var g=u[0];g<=u[1];g++){l.beginPath();for(var p=0,m=s.length;p<m;p++){t=s[p];for(var y=0,x=t.length;y<x;y++)a=t[y],a=n.toScreen([a[0]+g*h,a[1]]),e=0===y?"moveTo":"lineTo",l[e](a[0]+_[0],a[1]+_[1]);a=t[0],a=n.toScreen([a[0]+g*h,a[1]]),l.lineTo(a[0]+_[0],a[1]+_[1])}if(i.fill){if(i.fillImage){var C=G.Browser.getImageSrc(i.fillImage),w=G.DomUtil.getImgElement(C,function(){n._requestRedraw()},null,"*");w._loaded?(l.fillStyle=l.createPattern(w,"repeat"),l.globalAlpha=i.fillOpacity):l.globalAlpha=0}else l.fillStyle=i.fillColor,l.globalAlpha=i.fillOpacity;l.fill()}(i.outline||r._mouseOver||r._editing)&&(l.strokeStyle=r._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor,l.lineCap=i.outlineCap,l.lineJoin=i.outlineJoin,l.lineWidth=(i.outline?i.outlineWidth:0)+(r._mouseOver?i.lineHighlightWiden:0),l.globalAlpha=i.outlineOpacity,G.Util.setCanvasLineDash(l,i.outlineDashArray),l.stroke())}l.restore()},_drawMask:function(){var e,t,a,r=this,i=r._map,o=i._maskCtx,n=r.geom,l=i._canvasOffset,s=r.bbox,_=(s[0]+s[2])/2,d=(s[1]+s[3])/2,c=i._calcWrapPointRange([_,d])||[0,0],f=i.options.maxExtent,u=f[2]-f[0];o.beginPath();for(var v=c[0];v<=c[1];v++)for(var h=0,g=n.length;h<g;h++){t=n[h];for(var p=0,m=t.length;p<m;p++)a=t[p],a=i.toScreen([a[0]+v*u,a[1]]),e=0===p?"moveTo":"lineTo",o[e](a[0]+l[0],a[1]+l[1]);a=t[0],a=i.toScreen([a[0]+v*u,a[1]]),o.lineTo(a[0]+l[0],a[1]+l[1])}o.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Polyline=G.Graphic.Polyline.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a=this,r=a.options,i=a._layer,o=i._map,n=i._ctx,l=a.geom,s=o._canvasOffset,_=a.bbox,d=(_[0]+_[2])/2,c=(_[1]+_[3])/2,f=o._calcWrapPointRange([d,c])||[0,0],u=o.options.maxExtent,v=u[2]-u[0];n.save();for(var h=f[0];h<=f[1];h++){n.beginPath();for(var g=0;g<l.length;g++)t=l[g],t=o.toScreen([t[0]+h*v,t[1]]),e=0===g?"moveTo":"lineTo",n[e](t[0]+s[0],t[1]+s[1]);n.strokeStyle=a._editing?r.lineHighlightColor:r.lineColor,n.lineCap=r.lineCap,n.lineJoin=r.lineJoin,n.lineWidth=a._mouseOver?r.lineWidth+r.lineHighlightWiden:r.lineWidth,n.globalAlpha=r.lineOpacity,G.Util.setCanvasLineDash(n,r.lineDashArray),n.stroke()}n.restore()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Map=G.Map.extend({print:function(e,t){var a=this,r=G.DomUtil,i=G.Browser.getCanvasRatio(),o=a.getSize(),n=o[0],l=o[1],s=e||n,_=t||l,d=s/n,c=_/l,f=Math.max(d,c),u=a._onScreenCtx.canvas,v=u.width/i[0],h=u.height/i[1],g=r.create("canvas");return g.width=s,g.height=_,g.getContext("2d").drawImage(u,(s-v*f)/2,(_-h*f)/2,v*f,h*f),g.toDataURL()},_initAddition:function(){var e=this,t=G.DomUtil,a=e._useOffScreen=!window.G_OFF_CANVAS_OFFSCREEN;e._onScreenCtx=t.create("canvas","g-layer",e._layersFrame).getContext("2d"),a&&(e._offScreenCtx=t.create("canvas").getContext("2d")),e._snapshotCtx=t.create("canvas").getContext("2d"),e._maskCtx=t.create("canvas").getContext("2d"),e._mode="canvas"},_redrawSnapshot:function(e,t,a){var r,i,o,n,l,s,_,d=this,c=G.Browser.getCanvasRatio(),f=d._onScreenCtx.canvas,u=f.width/(c[0]||1),v=f.height/(c[1]||1),h=G.Browser.getPxRatio(),g=h[0],p=h[1],m=d._center,y=d._rotate,x=d._res,C=y-t,w=x/a,S=d._onScreenCtx;r=-u/2,i=-v/2,t&&(o=G.MathUtil.rotateVector([r,i],-t),r=o[0],i=o[1]),n=r*a*g+e[0],l=-i*a*p+e[1],r=(n-m[0])/x/g,i=-(l-m[1])/x/p,y&&(o=G.MathUtil.rotateVector([r,i],y),r=o[0],i=o[1]),s=u/2+r,_=v/2+i,d._clearCanvas(S),S.save(),S.translate(s,_),S.rotate(C/G.MathUtil.DEGREE_PER_RADIAN),S.drawImage(d._snapshotCtx.canvas,0,0,u/w,v/w),S.restore()},_redraw:function(){var e=this,t=e._useOffScreen,a=e._onScreenCtx.canvas,r=e._zoomAnim,i=e._rotateAnim,o=e._handlers.Pinch;if(!e.options.canvasAnimRedraw&&r&&r._playing)return void e._redrawSnapshot(r._startCenter,e._rotate,r._startRes);if(!e.options.canvasAnimRedraw&&i&&i._playing)return void e._redrawSnapshot(e._center,i._startRotate,e._res);if(!e.options.canvasAnimRedraw&&o&&o._pinching)return void e._redrawSnapshot(o._startCenter,o._startRotate,o._startRes);t?e._clearCanvas(e._offScreenCtx):e._clearCanvas(e._onScreenCtx);var n,l,s;for(n in e._layerOrder)l=e._layerOrder[n],s=e._layers[l],s&&s.isVisible()&&s._draw();if(e._drawMask(),t){ratio=G.Browser.getCanvasRatio(),w=a.width/(ratio[0]||1),h=a.height/(ratio[1]||1);try{e._clearCanvas(e._onScreenCtx),e._onScreenCtx.drawImage(e._offScreenCtx.canvas,0,0,w,h)}catch(_){}}try{e._onScreenCtx.drawImage(e._maskCtx.canvas,0,0)}catch(_){}e.fireEvent("redraw")},_update:function(){var e,t,a,r=this,i=r._useOffScreen,o=r._onScreenCtx.canvas;i?r._clearCanvas(r._offScreenCtx):r._clearCanvas(r._onScreenCtx);var n,l,s;for(n in r._layerOrder)l=r._layerOrder[n],s=r._layers[l],s&&s.isVisible()&&s._update();if(r._drawMask(),i){e=G.Browser.getCanvasRatio(),t=o.width/(e[0]||1),a=o.height/(e[1]||1);try{r._clearCanvas(r._onScreenCtx),r._onScreenCtx.drawImage(r._offScreenCtx.canvas,0,0,t,a)}catch(_){}}try{r._onScreenCtx.drawImage(r._maskCtx.canvas,0,0)}catch(_){}r.fireEvent("update")},_drawMask:function(){var e,t,a=this,r=a._maskCtx,i=a.options,o=a._masks;if(o){var n=o.length;if(i.mask){if(a._clearCanvas(a._maskCtx),0==n)return;for(r.save(),r.globalCompositeOperation="source-over",r.fillStyle=i.maskColor,r.globalAlpha=i.maskOpacity,r.fillRect(0,0,r.canvas.width,r.canvas.height),r.globalCompositeOperation="destination-out",r.globalAlpha=1,e=0;e<n;e++)t=o[e],t._drawMask&&t._drawMask();r.restore()}}},_onResize:function(){var e=this;e._resizeCanvases(),e._updateDrawSize(),e._requestUpdate()},_clearCanvas:function(e){var t=e.canvas,a=Math.ceil,r=a(t.width),i=a(t.height);e.clearRect(0,0,r,i);var o=G.Browser;if(o.webkit533||o.webkit534){var n=t.style,l=n.display;n.display="none",t.offsetHeight,n.display=l}},_resizeCanvas:function(e,t,a,r){if(e&&t&&a){var i=this,o=e.canvas,n=r?r[0]||1:1,l=r?r[1]||1:1,s=i.options.canvasExpandFactor,_=t*s,d=a*s,c=t+2*_,f=a+2*d;G.DomUtil.setPosition(o,-_,-d),1==n&&1==l?(o.width=c,o.height=f,o.style.width="",o.style.height="",e.scale(1,1)):(o.width=c*n,o.height=f*l,o.style.width=c+"px",o.style.height=f+"px",e.scale(n,l))}},_resizeCanvases:function(){var e=this,t=e.getSize(),a=t[0],r=t[1],i=G.Browser.getCanvasRatio(),o=(i?i[0]||1:1,i?i[1]||1:1,e.options.canvasExpandFactor),n=a*o,l=r*o;e._canvasOffset=[n,l],e._resizeCanvas(e._onScreenCtx,a,r,i),e._resizeCanvas(e._snapshotCtx,a,r,i),e._resizeCanvas(e._maskCtx,a,r,[1,1]),e._useOffScreen&&e._resizeCanvas(e._offScreenCtx,a,r,i)},_onZoomStart:function(e){this._snapshotCanvas()},_onRotateStart:function(e){this._snapshotCanvas()},_onPinchStart:function(e){this._snapshotCanvas()},_snapshotCanvas:function(){var e=this;if(!e.options.canvasAnimRedraw){var t=e._onScreenCtx.canvas,a=G.Browser.getCanvasRatio(),r=t.width/(a[0]||1),i=t.height/(a[1]||1);e._clearCanvas(e._snapshotCtx),e._snapshotCtx.drawImage(t,0,0,r,i)}},_calcCanvasOffset:function(){var e=this,t=e.getSize(),a=e.getDrawSize(),r=a[0],i=a[1],o=(t[0]-r)/2,n=(t[1]-i)/2;return[o,n]},_beforeMergeFramePos:function(){var e=this,t=e._mapFrame,a=G.DomUtil,r=a.getPosition(t),i=r[0],o=r[1],n=e._spark;if(n){var l=a.getPosition(n)||[0,0];a.markPosTransform(n,l[0]+i,l[1]+o),a.updateTransform(n)}try{e._onScreenCtx.drawImage(e._onScreenCtx.canvas,i,o)}catch(s){}}});